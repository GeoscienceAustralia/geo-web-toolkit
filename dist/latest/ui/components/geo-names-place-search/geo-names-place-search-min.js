(function(){var a=angular.module("gawebtoolkit.ui.components.geo-place-name-search",["gawebtoolkit.ui.directives","ui.utils","gawebtoolkit.utils"]);a.directive("geoNamesPlaceSearch",["$http","$q","$timeout",function(d,b,c){return{restrict:"E",templateUrl:"src/main/js/ui/components/geo-names-place-search/geo-names-place-search.html",scope:{mapController:"=",searchIconUrl:"@",geoNamesApiKey:"@",zoomLevel:"@",countryCode:"@",resultTemplateUrl:"@",onResults:"&",onResultsSelected:"&",onPerformSearch:"&",activateKey:"@"},controller:["$scope",function(e){}],link:function(g,e){var f=e.find('input[type="text"]')[0];e.bind("keydown",function(i){if(i.keyCode==g.activateKey){if(g.typeAheadSelected){return}g.searchButtonClicked();g.$apply()}});var h=function(l,j){if(typeof l==="object"){l=l.properties.name}g.searchResults=[];var i=b.defer();g.waitingForResponse=true;var k="http://api.geonames.org/searchJSON?q="+encodeURIComponent(l).replace("%20","+")+"&maxRows="+j+"&country="+g.countryCode.toUpperCase()+"&username="+g.geoNamesApiKey;d.get(k).success(function(o){g.waitingForResponse=false;var n=[];for(var m=0;m<o.geonames.length;m++){var p=o.geonames[m];n.push(g.convertGeoNameToGeoJson(p))}i.resolve(n)});return i.promise};g.getSearchResults=function(i){if(!(i!=null&&i.length>=3)){return[]}return h(i,10).then(function(j){if(g.searchInProgress){return[]}g.onResults({data:j});return j})};g.onSelected=function(i){g.typeAheadSelected=true;c(function(){g.typeAheadSelected=false},50);g.onResultsSelected({item:i})};g.searchButtonClicked=function(){g.searchInProgress=true;if(g.query!=null){return h(g.query,50).then(function(i){g.searchInProgress=false;g.onPerformSearch({data:i});return i})}};g.convertGeoNameToGeoJson=function(j){var i={type:"Feature",geometry:{type:"Point",coordinates:[j.lng,j.lat]},crs:{type:"name",properties:{name:"EPSG:4326"}}};i.properties={};for(var k in j){if(j.hasOwnProperty(k)){i.properties[k]=j[k]}}return i}}}}])})();